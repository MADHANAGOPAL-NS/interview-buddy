<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HR Round - DARKCONQ</title>
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .hr-container {
      background-color: #ffffff;
      border-radius: 12px;
      padding: 40px;
      width: 600px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
      text-align: center;
    }
    .hr-container h2 {
      font-size: 28px;
      margin-bottom: 20px;
      color: #1f2937;
    }
    .voice-toggle {
      margin-bottom: 20px;
      font-size: 16px;
      color: #374151;
    }
    .question-box {
      background-color: #f9fafb;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 20px;
      font-size: 20px;
      font-weight: 500;
      color: #1f2937;
      min-height: 100px;
      margin-bottom: 30px;
      animation: fadeIn 0.6s ease-in-out;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }
    .record-button,
    .retry-button,
    .next-button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .record-button {
      background-color: #10b981;
      color: white;
    }
    .record-button:hover {
      background-color: #059669;
    }
    .retry-button {
      background-color: #f59e0b;
      color: white;
    }
    .retry-button:hover {
      background-color: #d97706;
    }
    .next-button {
      background-color: #2563eb;
      color: white;
    }
    .next-button:hover {
      background-color: #1d4ed8;
    }
    .suggestion-box {
      background-color: #fef3c7;
      border: 1px solid #fcd34d;
      border-radius: 8px;
      padding: 16px;
      font-size: 16px;
      color: #92400e;
      min-height: 60px;
      text-align: left;
      white-space: pre-wrap;
      overflow: hidden;
      margin-bottom: 20px;
    }
    #loader {
      display: none;
      margin: 20px auto 0;
      width: fit-content;
      font-size: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }
  </style>
  <script src="jquery-3.7.1.min.js"></script>
</head>
<body>
  <div class="hr-container">
    <h2>HR Round</h2>
    <div class="voice-toggle">
      <label>
        <input type="checkbox" id="voiceToggle" checked>
        üîä Read questions aloud
      </label>
    </div>
    <div class="question-box" id="hrQuestionBox">
      Loading behavioural question...
    </div>
    <div class="controls">
      <button class="record-button" id="startRecording">üéôÔ∏è Start Recording</button>
      <button class="retry-button" id="retryButton" style="display: none;">üîÑ Try Again</button>
      <button class="next-button">Next Question</button>
    </div>
    <div class="suggestion-box" id="suggestionBox">
      Suggestions based on your answer will appear here.
    </div>
    <div id="loader">üîÑ</div>
  </div>

  <script>
    $(document).ready(function () {
      let questions = [];
      let currentIndex = 0;
      let isMaleVoice = true;
      let maleVoice = null;
      let femaleVoice = null;

      const MAX_SILENCE = 20000;
      let silenceTimer = null;

      function assignVoices() {
        const all = speechSynthesis.getVoices();
        maleVoice = all.find(v => v.name.includes("David") || v.name.includes("Alex")) || all[0];
        femaleVoice = all.find(v => v.name.includes("Samantha") || v.name.includes("Zira")) || all[1] || all[0];
      }

      function extractQuestionOnly(text) {
        const parts = text.split(":");
        return parts.length > 1 ? parts.slice(1).join(":").trim() : text;
      }

      function typeAndSpeakPhrases(text, isMale, cb) {
        const phrases = text.match(/[^.,!?]+[.,!?]?/g) || [text];
        let i = 0;
        $("#hrQuestionBox").html("");
        function next() {
          if (i < phrases.length) {
            const p = phrases[i++].trim() + " ";
            $("#hrQuestionBox").append(p);
            if ($("#voiceToggle").is(":checked")) {
              const u = new SpeechSynthesisUtterance(extractQuestionOnly(p));
              u.voice = isMale ? maleVoice : femaleVoice;
              u.lang = 'en-US';
              u.rate = 1.1;
              speechSynthesis.speak(u);
            }
            setTimeout(next, Math.max(600, p.length * 40));
          } else if (cb) {
            cb();
          }
        }
        next();
      }

      function animateFeedback(text) {
        const box = $("#suggestionBox");
        box.html("");
        let i = 0;
        (function type() {
          if (i < text.length) {
            box.append(text.charAt(i++));
            setTimeout(type, 30);
          }
        })();
      }

      function resetAnswer() {
        $("#loader").hide();
        $("#retryButton").hide();
        $("#startRecording").show().prop("disabled", false);
        animateFeedback("Suggestions based on your answer will appear here.");
      }

      function showQuestion(idx) {
        resetAnswer();

        if (idx < questions.length) {
          typeAndSpeakPhrases(questions[idx], isMaleVoice);
          isMaleVoice = !isMaleVoice;
        } else {
          const finalMsg =
            "Thank you for participating in the HR round. Your responses were thoughtful and well-articulated. We wish you great success ahead.";

          $("#hrQuestionBox").html("<p>HR round complete. Thank you!</p>");
          $(".next-button").hide();

          if ($("#voiceToggle").is(":checked")) {
            const utter = new SpeechSynthesisUtterance(finalMsg);
            utter.voice = maleVoice;
            utter.lang = "en-US";
            utter.rate = 1.1;
            speechSynthesis.speak(utter);
          }

          setTimeout(() => {
            animateFeedback(finalMsg);
          }, 500);
        }
      }

      $(".next-button").on("click", () => {
        currentIndex++;
        showQuestion(currentIndex);
      });

      $("#retryButton").on("click", resetAnswer);

      $("#startRecording").on("click", function () {
        if (!("webkitSpeechRecognition" in window)) {
          alert("Voice recognition not supported.");
          return;
        }

        $(this).prop("disabled", true);
        $("#loader").show();
        animateFeedback("üß† Still listening... take your time.");

        const recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = "en-US";

        function resetSilence() {
          clearTimeout(silenceTimer);
          silenceTimer = setTimeout(() => recognition.stop(), MAX_SILENCE);
        }

        recognition.onspeechstart = resetSilence;
        recognition.onresult = event => {
          resetSilence();
          const answer = event.results[0][0].transcript.trim();
          animateFeedback(`üí¨ You answered:\n"${answer}"\n\n‚è≥ Evaluating your answer...`);

          $.ajax({
            url: "http://localhost:8000/api/hr_questions/feedback",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
              question: questions[currentIndex],
              answer: answer
            }),
            success: res => {
              clearTimeout(silenceTimer);
              $("#loader").hide();
              $("#startRecording").hide();
              $("#retryButton").show().prop("disabled", false);
              animateFeedback(`üîé Feedback:\n${res.feedback || "No feedback received."}`);
            },
            error: () => {
              clearTimeout(silenceTimer);
              $("#loader").hide();
              $("#startRecording").prop("disabled", false);
              $("#retryButton").show();
              animateFeedback("‚ùå Failed to fetch feedback. Please try again.");
            }
          });
        };

        recognition.onerror = () => {
          clearTimeout(silenceTimer);
          $("#loader").hide();
          $("#startRecording").prop("disabled", false);
          $("#retryButton").show();
          animateFeedback("üé§ Voice recognition failed. Please try again.");
        };

        recognition.start();
        resetSilence();
      });

      const resumeId = localStorage.getItem("resume_id");
      if (!resumeId) {
        $("#hrQuestionBox").html("<p>Resume ID not found. Please register first.</p>");
        $(".next-button").hide();
        return;
      }

      $.ajax({
        url: `http://localhost:8000/api/hr_questions/start?resume_id=${resumeId}`,
        type: "GET",
        success: resp => {
          questions = resp.questions;
          const iv = setInterval(() => {
            if (speechSynthesis.getVoices().length) {
              assignVoices();
              clearInterval(iv);
              const warmUp = new SpeechSynthesisUtterance(" ");
              warmUp.voice = maleVoice;
              warmUp.lang = "en-US";
              speechSynthesis.speak(warmUp);
              setTimeout(() => showQuestion(currentIndex), 300);
            }
          }, 100);
        },
        error: () => {
          $("#hrQuestionBox").html("<p>Failed to load HR questions.</p>");
        }
      });
    });
  </script>
</body>
</html>
