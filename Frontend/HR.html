<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HR Round - DARKCONQ</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600&display=swap"
    rel="stylesheet"
  >
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      position: relative;
    }

    /* Startup modal */
    #hrStartModal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex; justify-content: center; align-items: center;
      z-index: 2000;
    }
    #hrStartModal .modal-content {
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    #hrStartModal p {
      margin-bottom: 20px;
      color: #1f2937;
      font-size: 16px;
    }
    #hrStartModal button {
      margin: 0 10px;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #hrAllowBtn {
      background-color: #10b981; color: #fff;
    }
    #hrAllowBtn:hover {
      background-color: #059669;
    }
    #hrDenyBtn {
      background-color: #ef4444; color: #fff;
    }
    #hrDenyBtn:hover {
      background-color: #dc2626;
    }

    /* Floating webcam feed */
    #webcamFeed {
      position: fixed;
      top: 20px; right: 20px;
      width: 240px; height: 180px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      background: black;
      z-index: 1000;
      display: none;
    }

    .hr-container {
      background-color: #fff;
      border-radius: 12px;
      padding: 40px;
      width: 600px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
      text-align: center;
      position: relative;
      z-index: 1;
    }
    .hr-container h2 {
      font-size: 28px;
      margin-bottom: 20px;
      color: #1f2937;
    }
    .question-box {
      background: #f9fafb;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 20px;
      font-size: 20px;
      font-weight: 500;
      color: #1f2937;
      min-height: 100px;
      margin-bottom: 30px;
      animation: fadeIn 0.6s ease-in-out;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }
    button.record-button,
    button.retry-button,
    button.next-button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button.record-button { background: #10b981; color: #fff; }
    button.record-button:hover { background: #059669; }
    button.retry-button  { background: #f59e0b; color: #fff; }
    button.retry-button:hover { background: #d97706; }
    button.next-button { background: #2563eb; color: #fff; }
    button.next-button:hover { background: #1d4ed8; }

    .suggestion-box {
      background: #fef3c7;
      border: 1px solid #fcd34d;
      border-radius: 8px;
      padding: 16px;
      font-size: 16px;
      color: #92400e;
      min-height: 60px;
      text-align: left;
      white-space: pre-wrap;
      overflow: hidden;
      margin-bottom: 20px;
    }

    #loader {
      display: none;
      margin: 20px auto 0;
      font-size: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }
  </style>
  <script src="jquery-3.7.1.min.js"></script>
</head>
<body>

  <!-- Startup modal -->
  <div id="hrStartModal">
    <div class="modal-content">
      <p>
        To begin the HR round, we need access to your webcam.<br>
        Please click ‚ÄúAllow‚Äù to continue or ‚ÄúDeny‚Äù to exit.
      </p>
      <button id="hrAllowBtn">Allow</button>
      <button id="hrDenyBtn">Deny</button>
    </div>
  </div>

  <!-- Floating webcam feed -->
  <video id="webcamFeed" autoplay muted playsinline></video>

  <div class="hr-container">
    <h2>HR Round</h2>

    <div class="question-box" id="hrQuestionBox">
      Loading behavioural question...
    </div>

    <div class="controls">
      <button class="record-button" id="startRecording">üéôÔ∏è Start Recording</button>
      <button class="retry-button" id="retryButton" style="display: none;">üîÑ Try Again</button>
      <button class="next-button">Next Question</button>
    </div>

    <div class="suggestion-box" id="suggestionBox">
      Suggestions based on your answer will appear here.
    </div>

    <div id="loader">üîÑ</div>
  </div>

  <script>
    $(document).ready(function () {
      let questions = [];
      let currentIndex = 0;
      let isMaleVoice = true;
      let maleVoice = null;
      let femaleVoice = null;
      let cameraReady = false;

      const MAX_SILENCE = 20000;
      let silenceTimer = null;

      // Initialize webcam
      async function initCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          $("#webcamFeed").show().get(0).srcObject = stream;
          cameraReady = true;
        } catch (err) {
          cameraReady = false;
          alert("Camera access is required to participate in the HR round.");
          $(".next-button, #startRecording").prop("disabled", true);
          $("#hrQuestionBox").html(
            "<p>Camera access denied. Please enable your webcam to begin.</p>"
          );
        }
      }

      // TTS voice assignment
      function assignVoices() {
        const all = speechSynthesis.getVoices();
        maleVoice =
          all.find(v => v.name.includes("David") || v.name.includes("Alex")) || all[0];
        femaleVoice =
          all.find(v => v.name.includes("Samantha") || v.name.includes("Zira")) ||
          all[1] ||
          all[0];
      }

      // Helpers
      function extractQuestionOnly(text) {
        const parts = text.split(":");
        return parts.length > 1 ? parts.slice(1).join(":").trim() : text;
      }

      function typeAndSpeakPhrases(text, isMale, cb) {
        const phrases = text.match(/[^.,!?]+[.,!?]?/g) || [text];
        let i = 0;
        $("#hrQuestionBox").html("");
        (function next() {
          if (i < phrases.length) {
            const p = phrases[i++].trim() + " ";
            $("#hrQuestionBox").append(p);

            const utter = new SpeechSynthesisUtterance(extractQuestionOnly(p));
            utter.voice = isMale ? maleVoice : femaleVoice;
            utter.lang = "en-US";
            utter.rate = 1.1;
            speechSynthesis.speak(utter);

            setTimeout(next, Math.max(600, p.length * 40));
          } else if (cb) {
            cb();
          }
        })();
      }

      function animateFeedback(text) {
        const box = $("#suggestionBox");
        box.html("");
        let i = 0;
        (function typeChar() {
          if (i < text.length) {
            box.append(text.charAt(i++));
            setTimeout(typeChar, 30);
          }
        })();
      }

      function resetAnswer() {
        $("#loader").hide();
        $("#retryButton").hide();
        $("#startRecording").show().prop("disabled", false);
        animateFeedback("Suggestions based on your answer will appear here.");
      }

      // Show next question or finish
      function showQuestion(idx) {
        if (!cameraReady) {
          $("#hrQuestionBox").html(
            "<p>Camera access is required to begin the HR round.</p>"
          );
          return;
        }

        resetAnswer();

        if (idx < questions.length) {
          typeAndSpeakPhrases(questions[idx], isMaleVoice);
          isMaleVoice = !isMaleVoice;
        } else {
          const finalMsg =
            "Thank you for participating in the HR round. " +
            "Your responses were thoughtful and well-articulated. " +
            "We wish you great success ahead.";

          $("#hrQuestionBox").html("<p>HR round complete. Thank you!</p>");
          $(".next-button").hide();
          $("#startRecording").remove();

          // Speak final message
          const utter = new SpeechSynthesisUtterance(finalMsg);
          utter.voice = maleVoice;
          utter.lang = "en-US";
          utter.rate = 1.1;
          speechSynthesis.speak(utter);

          // Replace suggestion box with final message
          $("#suggestionBox").html(finalMsg);
        }
      }

      // Event bindings
      $(".next-button").on("click", () => {
        currentIndex++;
        showQuestion(currentIndex);
      });

      $("#retryButton").on("click", resetAnswer);

      $("#startRecording").on("click", function () {
        if (!("webkitSpeechRecognition" in window)) {
          alert("Voice recognition not supported.");
          return;
        }
        $(this).prop("disabled", true);
        $("#loader").show();
        animateFeedback("Still listening... take your time.");

        const recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = "en-US";

        function resetSilence() {
          clearTimeout(silenceTimer);
          silenceTimer = setTimeout(() => recognition.stop(), MAX_SILENCE);
        }

        recognition.onspeechstart = resetSilence;
        recognition.onresult = event => {
          resetSilence();
          const answer = event.results[0][0].transcript.trim();
          animateFeedback(`You answered:\n"${answer}"\n\nEvaluating your answer...`);

          $.ajax({
            url: "http://localhost:8000/api/hr_questions/feedback",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
              question: questions[currentIndex],
              answer: answer
            }),
            success: res => {
              clearTimeout(silenceTimer);
              $("#loader").hide();
              $("#startRecording").hide();
              $("#retryButton").show().prop("disabled", false);
              animateFeedback(`Feedback:\n${res.feedback || "No feedback received."}`);
            },
            error: () => {
              clearTimeout(silenceTimer);
              $("#loader").hide();
              $("#startRecording").prop("disabled", false);
              $("#retryButton").show();
              animateFeedback("Failed to fetch feedback. Please try again.");
            }
          });
        };

        recognition.onerror = () => {
          clearTimeout(silenceTimer);
          $("#loader").hide();
          $("#startRecording").prop("disabled", false);
          $("#retryButton").show();
          animateFeedback("Voice recognition failed. Please try again.");
        };

        recognition.start();
        resetSilence();
      });

      // Allow/Deny logic
      $("#hrAllowBtn").on("click", () => {
        $("#hrStartModal").hide();
        initCamera();
        loadQuestions();
      });

      $("#hrDenyBtn").on("click", () => {
        $("#hrStartModal").hide();
        $(".next-button, #startRecording").prop("disabled", true);
        $("#hrQuestionBox").html(
          "<p>You denied access. HR round cannot proceed.</p>"
        );
      });

      // Load questions from backend
      function loadQuestions() {
        const resumeId = localStorage.getItem("resume_id");
        if (!resumeId) {
          $("#hrQuestionBox").html(
            "<p>Resume ID not found. Please register first.</p>"
          );
          $(".next-button").hide();
          return;
        }

        $.ajax({
          url: `http://localhost:8000/api/hr_questions/start?resume_id=${resumeId}`,
          type: "GET",
          success: resp => {
            questions = resp.questions;
            const iv = setInterval(() => {
              if (speechSynthesis.getVoices().length) {
                assignVoices();
                clearInterval(iv);
                // Warm up TTS
                const warmUp = new SpeechSynthesisUtterance(" ");
                warmUp.voice = maleVoice;
                warmUp.lang = "en-US";
                speechSynthesis.speak(warmUp);
                setTimeout(() => showQuestion(currentIndex), 300);
              }
            }, 100);
          },
          error: () => {
            $("#hrQuestionBox").html(
              "<p>Failed to load HR questions.</p>"
            );
          }
        });
      }
    });
  </script>
</body>
</html>
